version: 1

project:
  name: my-app
  defaultProfile: local

registry:
  prefix: ""  # e.g. myregistry.azurecr.io/my-app

profiles:

  # ── local ─────────────────────────────────────────────────────────────────
  # Built from source. Run with: devx up
  local:
    runtime: compose
    services:
      api:
        build:
          context: ./src/api
          dockerfile: Dockerfile
        ports:
          - "8080:80"
        env:
          APP_ENV: development
          DB_HOST: db
          DB_PORT: "5432"
          DB_NAME: appdb
          DB_USER: postgres
          DB_PASSWORD: postgres
          REDIS_URL: redis://cache:6379
        dependsOn:
          - db
          - cache
        health:
          httpGet: http://localhost:8080/health
          interval: 5s
          retries: 12

      worker:
        build:
          context: ./src/worker
          dockerfile: Dockerfile
        env:
          APP_ENV: development
          DB_HOST: db
          DB_PASSWORD: postgres
        dependsOn:
          - db
          - cache

    deps:
      db:
        kind: postgres
        version: "16"
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: appdb
        ports:
          - "5432:5432"
        volume: "db-data:/var/lib/postgresql/data"

      cache:
        kind: redis
        version: "7"
        ports:
          - "6379:6379"

    hooks:
      afterUp:
        - exec: "migrate up"
          service: api
        - run: "./scripts/seed-dev.sh"
      beforeDown:
        - exec: "migrate down"
          service: api

  # ── ci ────────────────────────────────────────────────────────────────────
  # Pre-built images. Run with: devx up --profile ci
  ci:
    runtime: compose
    services:
      api:
        image: myregistry.azurecr.io/my-app/api:latest
        env:
          APP_ENV: test
          DB_HOST: db
          DB_PORT: "5432"
          DB_NAME: appdb
          DB_USER: postgres
          DB_PASSWORD: postgres
        dependsOn:
          - db

    deps:
      db:
        kind: postgres
        version: "16"
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: appdb
        ports:
          - "5432:5432"

    hooks:
      afterUp:
        - exec: "migrate up"
          service: api

  # ── staging ───────────────────────────────────────────────────────────────
  # Compose on a staging server. Run with: devx up --profile staging
  staging:
    runtime: compose
    services:
      api:
        image: myregistry.azurecr.io/my-app/api:stable
        ports:
          - "80:8080"
        env:
          APP_ENV: staging
          DB_HOST: db
          DB_PASSWORD: "${DB_PASSWORD}"
        dependsOn:
          - db
        health:
          httpGet: http://localhost/health
          interval: 10s
          retries: 6

    deps:
      db:
        kind: postgres
        version: "16"
        env:
          POSTGRES_PASSWORD: "${DB_PASSWORD}"
          POSTGRES_DB: appdb
        ports:
          - "5432:5432"
        volume: "staging-db-data:/var/lib/postgresql/data"

    hooks:
      afterUp:
        - exec: "migrate up"
          service: api

  # ── k8s ───────────────────────────────────────────────────────────────────
  # Kubernetes via kubectl. Run with: devx up --profile k8s
  k8s:
    runtime: k8s
    services:
      api:
        image: myregistry.azurecr.io/my-app/api:latest
        ports:
          - "80:8080"
        env:
          APP_ENV: production
          DB_HOST: db
          DB_PORT: "5432"
          DB_NAME: appdb
          DB_USER: postgres
          DB_PASSWORD: postgres
        dependsOn:
          - db

      worker:
        image: myregistry.azurecr.io/my-app/worker:latest
        env:
          APP_ENV: production
          DB_HOST: db
          DB_PASSWORD: postgres
        dependsOn:
          - db

    deps:
      db:
        kind: postgres
        version: "16"
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: appdb
        ports:
          - "5432:5432"
